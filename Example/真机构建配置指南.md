# 真机构建配置指南

✅ **CocoaPods 已成功安装！**

现在需要在 Xcode 中配置真机构建。

---

## 📱 第 1 步：在 Xcode 中打开项目

```bash
cd /Users/raoqu/mylab/iosShare/Example
open XExtensionItemExample.xcworkspace
```

⚠️ **重要：** 必须打开 `.xcworkspace` 文件，不是 `.xcodeproj`

---

## 🔧 第 2 步：配置主应用的代码签名

### 1. 选择主应用 Target

在 Xcode 中：
1. 点击左侧 **项目图标**（蓝色的 XExtensionItemExample）
2. 在 TARGETS 列表中，选择 **"App"** 或 **"XExtensionItemExample"**

### 2. 配置 Signing & Capabilities

1. 点击 **"Signing & Capabilities"** 标签
2. ✅ 勾选 **"Automatically manage signing"**
3. 在 **Team** 下拉框中选择你的 Apple Developer Team
   - 如果没有 Team，需要：
     - 免费账号：Xcode → Preferences → Accounts → 添加你的 Apple ID
     - 付费账号：使用你的开发者账号登录

4. **Bundle Identifier** 会自动调整为：
   ```
   com.yourname.XExtensionItemExample  (或类似)
   ```

### 3. 配置部署目标

1. 在同一个 Target 页面
2. 点击 **"General"** 标签
3. 找到 **"Minimum Deployments"** 部分
4. 确保 **"iOS"** 设置为 **14.0** 或更高

---

## 🔧 第 3 步：配置 Extension Target 的代码签名

### 1. 选择 Extension Target

在 TARGETS 列表中，找到并选择：
- **"Extension"** 或
- **"XExtensionItemExample Extension"** 或类似名称

### 2. 配置 Signing & Capabilities

1. 点击 **"Signing & Capabilities"** 标签
2. ✅ 勾选 **"Automatically manage signing"**
3. 在 **Team** 下拉框中选择**相同的** Apple Developer Team
4. **Bundle Identifier** 应该自动设置为：
   ```
   com.yourname.XExtensionItemExample.Extension
   ```
   （必须是主应用 ID + .Extension）

### 3. 配置部署目标

1. 点击 **"General"** 标签
2. 确保 **"iOS"** 设置为 **14.0** 或更高

---

## 🔧 第 4 步：配置 Pods Targets

### 配置 Pods-App

1. 在 TARGETS 列表中选择 **"Pods-App"**
2. 点击 **"Build Settings"** 标签
3. 搜索框输入：`code signing`
4. 找到 **"Code Signing Identity"**
   - **Debug** → 设置为 `iOS Developer`
   - **Release** → 设置为 `iOS Developer`

### 配置 Pods-Extension

1. 在 TARGETS 列表中选择 **"Pods-Extension"**
2. 点击 **"Build Settings"** 标签
3. 搜索框输入：`code signing`
4. 找到 **"Code Signing Identity"**
   - **Debug** → 设置为 `iOS Developer`
   - **Release** → 设置为 `iOS Developer`

---

## 📱 第 5 步：连接 iPhone 并构建

### 1. 连接 iPhone

1. 用 USB 线连接 iPhone 到 Mac
2. 在 iPhone 上：
   - 如果弹出 **"信任此电脑"** 对话框，点击 **"信任"**
   - 输入 iPhone 密码

### 2. 选择设备

在 Xcode 顶部：
1. 点击设备选择器（Scheme 旁边）
2. 在 **iOS Device** 部分，选择你的 iPhone 名称

### 3. 构建并运行

```
⌘ + Shift + K  (Clean Build Folder)
⌘ + B          (Build)
⌘ + R          (Run)
```

### 4. 首次运行需要信任开发者证书

在 iPhone 上：
1. 应用安装后可能无法直接打开
2. 打开 **设置** → **通用** → **VPN 与设备管理**
3. 找到你的开发者账号
4. 点击 **"信任 [你的账号]"**
5. 确认信任
6. 返回主屏幕，现在可以打开应用了

---

## ✅ 第 6 步：测试 Share Extension

### 在 iPhone 上测试

1. **打开照片应用**
2. 选择一张照片
3. 点击 **分享按钮** ⬆️
4. 查找 **"发送到TransAny"**

**如果没看到：**
1. 在分享菜单滚动到底部
2. 点击 **"编辑操作"** 或 **"更多"**
3. 找到 **"发送到TransAny"**
4. 确保开关是**打开**的（绿色）
5. 可以拖动它到列表顶部
6. 点击 **"完成"**

### 也可以在其他应用测试

- **Safari**: 分享网页或 URL
- **备忘录**: 分享文本
- **文件应用**: 分享 PDF、Word、Excel 等文档

---

## 🐛 常见问题解决

### 问题 1：无法选择 Team

**解决方案：**
1. Xcode → **Preferences** (⌘ + ,)
2. **Accounts** 标签
3. 点击 **"+"** 添加 Apple ID
4. 登录后会自动创建个人 Team（免费）

### 问题 2：Bundle Identifier 冲突

**错误信息：** `Failed to register bundle identifier`

**解决方案：**
1. 修改 Bundle Identifier 为独特的 ID
2. 例如：`com.yourname.uniqueapp.XExtensionItem`
3. Extension 的 ID 也要相应修改

### 问题 3：代码签名失败

**错误信息：** `Code signing error` 或 `Provisioning profile error`

**解决方案：**
1. 确保所有 Targets（App、Extension、Pods）使用相同的 Team
2. 清理构建：⌘ + Shift + K
3. 删除 DerivedData：
   ```bash
   rm -rf ~/Library/Developer/Xcode/DerivedData/*
   ```
4. 重新构建

### 问题 4：应用无法在 iPhone 上打开

**错误信息：** `Untrusted Developer`

**解决方案：**
1. iPhone 上：**设置** → **通用** → **VPN 与设备管理**
2. 找到开发者证书
3. 点击 **"信任"**

### 问题 5：Extension 不出现

**可能原因：**
- Extension 没有被正确安装
- Extension 的部署目标版本太高

**解决方案：**
1. 完全删除应用（长按图标 → 删除）
2. 在 Xcode 中 Clean (⌘ + Shift + K)
3. 重新构建并安装 (⌘ + R)
4. 重启 iPhone

### 问题 6：rsync 沙盒错误仍然出现

**解决方案：**
1. 检查 Framework 嵌入设置：
   - 项目 → App Target → General
   - **Frameworks, Libraries, and Embedded Content**
   - XExtensionItem.framework 应该设置为 **"Do Not Embed"**
   
2. 如果还有问题，编辑 Podfile 添加：
   ```ruby
   post_install do |installer|
     installer.pods_project.targets.each do |target|
       target.build_configurations.each do |config|
         config.build_settings['CODE_SIGN_IDENTITY'] = ''
       end
     end
   end
   ```
   然后重新运行 `pod install`

---

## 📋 检查清单

在开始构建之前，确认：

### 项目配置
- [ ] 已打开 `.xcworkspace` 文件（不是 `.xcodeproj`）
- [ ] CocoaPods 已成功安装（看到 "Pod installation complete!"）
- [ ] Podfile 中 platform 设置为 iOS 14.0

### 代码签名
- [ ] App Target 的 Team 已选择
- [ ] Extension Target 的 Team 已选择（与 App 相同）
- [ ] Pods-App 的 Code Signing Identity 已设置
- [ ] Pods-Extension 的 Code Signing Identity 已设置
- [ ] Bundle Identifiers 正确（Extension = App + .Extension）

### 部署目标
- [ ] App Target 的 Minimum Deployments ≥ iOS 14.0
- [ ] Extension Target 的 Minimum Deployments ≥ iOS 14.0

### 设备
- [ ] iPhone 已连接到 Mac
- [ ] iPhone 已信任此电脑
- [ ] iPhone 的 iOS 版本 ≥ 14.0
- [ ] Xcode 已选择你的 iPhone（不是模拟器）

### 构建
- [ ] 已执行 Clean Build Folder
- [ ] Build 成功（没有错误）
- [ ] 应用已安装到 iPhone
- [ ] 应用可以打开（如需要，已信任开发者证书）

### 测试
- [ ] 在照片应用中能看到分享按钮
- [ ] "发送到TransAny" 出现在分享菜单中
- [ ] 点击后能打开 Share Extension 界面
- [ ] Extension 能接收到分享的内容

---

## 🎯 成功标志

当一切正常时：

✅ Xcode 构建成功，没有错误  
✅ 应用安装到 iPhone 主屏幕  
✅ 应用可以正常打开和运行  
✅ 在照片应用的分享菜单中看到 "发送到TransAny"  
✅ 点击后能打开 Extension 界面  
✅ 没有 rsync 沙盒错误  
✅ 没有代码签名错误  

---

## 💡 提示

### 开发建议

1. **主应用和 Extension 必须使用相同的 Team**
2. **Bundle ID 必须有正确的层级关系**（Extension = App + .Extension）
3. **首次在新 iPhone 上安装需要信任开发者证书**
4. **Extension 的更新需要完全重新安装应用**

### 调试建议

1. 在 Xcode 中打开 Console (⌘ + Shift + Y) 查看日志
2. 在 ShareViewController.m 中添加 NSLog 输出
3. 使用 Xcode 的 Debug Navigator 监控内存和性能

---

## 🚀 下一步

配置成功后，你可以：

1. **自定义 Share Extension UI**
   - 修改 `ShareViewController.m`
   - 添加自定义界面元素
   - 实现具体的分享逻辑

2. **添加网络请求**
   - 将接收到的内容上传到服务器
   - 实现真正的"发送到 TransAny"功能

3. **优化用户体验**
   - 添加加载指示器
   - 显示上传进度
   - 处理错误情况

4. **启用 Swift UI（可选）**
   - 如果想使用之前创建的 Swift 界面
   - 按照 XCODE_SETUP_INSTRUCTIONS.md 配置

---

**现在开始在 Xcode 中配置代码签名！** 🎉
